<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript" src="js/kinetic-v4.3.3.min.js"></script>
    <script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="js/parserJson.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="css/styleInterface.css" charset="utf-8" />
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
	
	<!-- script et css pour miniature -->
<script src="miniature/highslide/highslide-with-gallery.js"></script>
<link rel="stylesheet" href="miniature/highslide/highslide.css" />

<!-- slider pour images miniatures -->
<script type="text/javascript">
	hs.graphicsDir = 'miniature/highslide/graphics/';
	hs.align = 'left top';
	hs.transitions = ['expand', 'crossfade'];
	hs.fadeInOut = true;
	hs.outlineType = 'rounded-white';
	hs.headingEval = 'this.a.title';
	hs.numberPosition = 'heading';
	hs.useBox = true;
	hs.width = 600;
	hs.height = 400;
	hs.showCredits = false;

	hs.addSlideshow({
		// slideshowGroup: 'group1',
		interval: 5000,
		repeat: false,
		useControls: false,
		fixedControls: 'fit',
		overlayOptions: {
			position: 'top center',
			offsetX: 200,
			offsetY: -65
		},
		thumbstrip: {
			position: 'rightpanel',
			mode: 'float',
			relativeTo: 'expander',
			width: '210px'
		}
	});
	
	var miniGalleryOptions1 = {
		thumbnailId: 'thumb1'
	}

</script>
	
    <title>Mus&eacutee virtuel</title>
</head>

<body>
    <div class="info">
    </div>
    <div id="myCarousel" class="contenu carousel slide" data-interval="false">
        <!-- Carousel indicator -->
        <ol class="carousel-indicators">
        </ol>
        <!-- Carousel item -->
        <div class="carousel-inner"></div>
        <!-- Carousel nav -->
        <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
        <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
    </div>
    <div class="navigation">
        <div id="container"></div>
    </div>




    <!-- script Navigation -->
    <script type="text/javascript">

        $(document).ready(parser("data/data.json"));

        function getURLParameter(name) {
            return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
        }

        function formatNameByLength(name, length) {
            if (name.length <= length) {
                return name;
            } else {
                return name.substring(0, length - 3) + "...";
            }
        }

        function showData(data) {

            function getNodeById(id) {
                for (var p in data.noeuds) {
                    if (data.noeuds[p].id == id) {
                        return data.noeuds[p];
                        break;
                    }
                }
                return null;
            }

            function getParcoursFromNode(node, id) {
                for (var p in node.parcours) {
                    if (node.parcours[p].id == id) {
                        return node.parcours[p];
                        break;
                    }
                }
                return null;
            }

            function isNodeParcours(node, id) {
                for (var p in node.parcours) {
                    if (node.parcours[p].id == id) {
                        return true;
                        break;
                    }
                }
                return false;
            }

            


            /* Recupération du parcours */
            var parcours = getURLParameter("parcours");

            if (parcours == null) {
                window.location = "index.html";
            }

            for (var p in data.info.parcours) {
                if (data.info.parcours[p].id == parcours) {
                    parcours = data.info.parcours[p];
                    break;
                }
            }

            if (parcours == null) {
                window.location = "index.html";
            }

            /* PARAMETRES COULEURS */
            var TEXTCOLOR = "white";
            var COLOR1 = parcours.couleur1;
            var COLOR2 = parcours.couleur2;
            var COLORDEFAULT = '#F58F00';
            var STROKECOLOR = 'black';

            /* Récupération du noeud en cours */

            var noeud = getURLParameter("noeud");
            
            if (noeud == null) {
                
                        noeud = parcours.debut;
                       
                }
                if (noeud == null) {
                    //TODO: Si mauvais numero parcours, retourner au caroussel
                    alert("Erreur, pas de noeuds");
                }
            

            for (var p in data.noeuds) {
                if (data.noeuds[p].id == noeud) {
                    noeud = data.noeuds[p];
                    break;
                }
            }


            /* Récupération de l'historique */

            var historique = [];

            if (getURLParameter("historique") != null) {
                historique = getURLParameter("historique").split("N");
            }

            /* Création du carroussel */

            var nbrImage = noeud.data.images;
            var nbrVideo = noeud.data.videos;
			var name = noeud.data.nom;
            var i =0;
            var j=0;
            var k=0;
            var l=0;
			
			
            //image
            if (nbrImage != null ){

				for (i =0; i<nbrImage; i++){
				    var actif="";
				    if(i==0){actif="class= active"}else{actif=""};				
				    $('.carousel-indicators').append("<li data-target=#myCarousel data-slide-to="+i+" "+actif+"></li>");
				}
	
				var image=j;
                for (j=0; j<nbrImage; j++){
                    var actif="";
                    image=j+1;
                    if (j==0){
                        actif="active ";
                        $('.carousel-inner').append("<div class=\"" + actif + "item\"><div class=imageCarrousel><img src=data/" + noeud.id + "/image" + image + ".jpg width=auto height=auto/></div> <div class=textCarrousel><p></p></div></div>");
                    }
                    else{
                        actif="";
                        $('.carousel-inner').append("<div class=\"" + actif + "item\"><img src=data/" + noeud.id + "/image" + image + ".jpg width=auto height=auto/></div>");
						
						$('.carousel-inner').append("<div class=\""+actif+"item\"> <div class='highslide-gallery' >"
								+"<a class='highslide' id='thumb1' href='miniature/images/thumbstrip11.jpg' onclick=\"return hs.expand(this,miniGalleryOptions1)\" title=\"Two cabins\"> <img src='miniature/images/thumbstrip11.jpg' margin-left:auto margin-right:auto width:50% height:50% alt=''/></a>"
								+"<div class=\"hidden-container\" margin-left:0%>"
								+"<a class='highslide' href='miniature/images/thumbstrip09.jpg' onclick=\"return hs.expand(this)\" title=\"Ptarmigan\"><img 			   src='miniature/images/thumbstrip09.thumb.png' alt=''/></a>"
								+"<a class='highslide' href='miniature/images/thumbstrip12.jpg' title=\"Patterns in the snow\" onclick=\"return hs.expand(this,miniGalleryOptions1)\"> <img src='miniature/images/thumbstrip12.thumb.png' alt=''/></a>"
								+"</div></div></div></div>");
                    }
					
                }


            }
			
            //video
            if(nbrVideo != null){
				nbrVideo=parseInt(nbrVideo)+i;
                for (k=i; k<nbrVideo; k++){
                    var actif="";
                    if(k==0){actif="class= active"}else{actif=""};				
                    $('.carousel-indicators').append("<li data-target=#myCarousel data-slide-to="+k+" "+actif+"></li>");
                }
				
				var adrVideo=1;
                for (l=j; l<nbrVideo; l++){
                    var actif="";
                    if (l==0){actif="active "}else{actif=""};
                    $('.carousel-inner').append("<div class=\"" + actif + "item\"><video controls=controls width=400 height=222><source src=data/" + noeud.id + "/video" + adrVideo + ".mp4 type=video/mp4 /><source src=video1.webm type=video/webm /><source src=video1.ogv type=video/ogg /></video></div></div>");
                    adrVideo++;
                }	
            }
			
			
            $('.textCarrousel p').load('data/' + noeud.id + '/resume.txt');
			$('.info').append("<p>"+parcours.nom+" - "+name+"<p>");


            /* Création de la scène */

            var stage = new Kinetic.Stage({
                container: 'container',
                width: document.body.clientWidth,
                height: 200
            });

            function writeMessage(messageLayer, message) {
                var context = messageLayer.getContext();
                messageLayer.clear();
                context.font = '18pt Calibri';
                context.fillStyle = TEXTCOLOR;
                context.fillText(message, 10, 25);
            }

            var debugLayer = new Kinetic.Layer();


            var lineLayer = new Kinetic.Layer();
            var shapesLayer = new Kinetic.Layer();

            var historiqueLayer = new Kinetic.Layer();
            var selectionLayer = new Kinetic.Layer();
            var futurLayer = new Kinetic.Layer();

            var noeudsDansHistorique;


            var zoneHistorique = new Kinetic.Rect({
                x: 0,
                y: 0,
                width: stage.getWidth() / 3,
                height: stage.getHeight(),
                fill: 'green',
                opacity: 0

            });


            var zoneSelection = new Kinetic.Rect({
                x: stage.getWidth() / 3,
                y: 0,
                width: stage.getWidth() / 3,
                height: stage.getHeight(),
                fill: 'blue',
                opacity: 0

            });

            var zoneFutur = new Kinetic.Rect({
                x: (stage.getWidth() / 3) * 2,
                y: 0,
                width: stage.getWidth() / 3,
                height: stage.getHeight(),
                fill: 'red',
                opacity: 0

            });



            var parcoursLine = new Kinetic.Line({
                points: [0, stage.getHeight() / 3, stage.getWidth(), stage.getHeight() / 3],
                stroke: COLOR1,
                strokeWidth: 15
            });

            var imageIndiceDrag= new Image();
            var indiceDrag1 = new Kinetic.Image({
                x: zoneHistorique.getX() + zoneHistorique.getWidth() / 6,
                y: (stage.getHeight() / 3) * 2 ,
                image: imageIndiceDrag,
                width: (zoneHistorique.getWidth() / 3) * 2,
                height: 20 * ((zoneHistorique.getWidth() / 3) * 2) / 168
            });

            var indiceDrag2 = new Kinetic.Image({
                x: zoneFutur.getX() + zoneFutur.getWidth() / 6,
                y: (stage.getHeight() / 3) * 2,
                image: imageIndiceDrag,
                width: (zoneFutur.getWidth() / 3) * 2,
                height: 20 * ((zoneFutur.getWidth() / 3) * 2) / 168
            });

            imageIndiceDrag.src = "images/indice_drag.png"

            historiqueLayer.add(indiceDrag1);
            futurLayer.add(indiceDrag2);

            /* Marqueurs de contenu caché */

            var pointilleGauche = new Kinetic.Group();

            var flecheGauche = new Kinetic.RegularPolygon({
                x: (stage.getWidth() / 3),
                y: stage.getHeight() / 3,
                sides: 3,
                radius: 20,
                fill: 'white',
                stroke: COLOR1,
                strokeWidth: 2,
                rotationDeg: 90
            });

            var flecheGauche2 = new Kinetic.RegularPolygon({
                x: (stage.getWidth() / 3) + 30,
                y: stage.getHeight() / 3,
                sides: 3,
                radius: 20,
                fill: 'white',
                stroke: COLOR1,
                strokeWidth: 2,
                rotationDeg: 90
            });

            pointilleGauche.add(flecheGauche);
            pointilleGauche.add(flecheGauche2);
            pointilleGauche.setOpacity(0);

            var pointilleDroite = new Kinetic.Group();

            var flecheDroite = new Kinetic.RegularPolygon({
                x: (stage.getWidth() / 3) * 2,
                y: stage.getHeight() / 3,
                sides: 3,
                radius: 20,
                fill: 'white',
                stroke: COLOR1,
                strokeWidth: 2,
                rotationDeg: 270
            });

            var flecheDroite2 = new Kinetic.RegularPolygon({
                x: (stage.getWidth() / 3) * 2 - 30,
                y: stage.getHeight() / 3,
                sides: 3,
                radius: 20,
                fill: 'white',
                stroke: COLOR1,
                strokeWidth: 2,
                rotationDeg: 270
            });


            pointilleDroite.add(flecheDroite);
            pointilleDroite.add(flecheDroite2);
            pointilleDroite.setOpacity(0);


            /* Zones draggable */

            var lastDrag = [-1, -1];

            var suiteParcours = [];
            var precedentParcours = [];

            function startDrag(zone, layer, obj, limite, cacherGauche, marqueur) {
                zone.on('mousemove touchmove', function () {
                    var mousePos = stage.getMousePosition();
                    if (lastDrag[0] != -1 && lastDrag[1] != -1) {
                        //writeMessage(debugLayer, "" + obj[0].children[0].getPosition().x + " - " + obj[0].children[0].getY());
                        
                        for (var o in obj) {
                            //obj[o].move(mousePos.x - lastDrag[0], 0);
                            for (var child in obj[o].children) {
                                if (obj[o].children[child].getName() == "line") {
                                    var points = obj[o].children[child].getPoints();
                                    points[0].x += mousePos.x - lastDrag[0];
                                    points[1].x += mousePos.x - lastDrag[0];
                                    obj[o].children[child].setPoints(points);
                                } else {
                                    obj[o].children[child].move(mousePos.x - lastDrag[0], 0);
                                }
                            }
                            if ((!cacherGauche && obj[o].children[0].getX() + obj[o].children[0].getWidth() > limite) || (cacherGauche && obj[o].children[0].getX() < limite)) {
                                if (o == 0) {
                                    marqueur.setOpacity(1);
                                }
                                if ((cacherGauche && Math.abs(obj[o].children[0].getX() - limite) > obj[o].children[0].getWidth()) || (!cacherGauche && obj[o].children[0].getX() > limite)) {
                                    obj[o].setOpacity(0);
                                } else {
                                    // Effet transparent
                                    var opacity = Math.abs(obj[o].children[0].getX() - limite) / obj[o].children[0].getWidth();
                                    if (cacherGauche) {
                                        opacity = 1 - opacity;
                                    }
                                    obj[o].setOpacity(opacity);
                                }
                            } else {
                                if (o == 0) {
                                    marqueur.setOpacity(0);
                                }
                                obj[o].setOpacity(1);
                            }

                        }
                        layer.draw();
                        selectionLayer.draw();
                    }
                    lastDrag[0] = mousePos.x;
                    lastDrag[1] = mousePos.y;
                });
            }

            function stopDrag(zone) {
                zone.off('mousemove touchmove');
                lastDrag[0] = -1;
                lastDrag[1] = -1;
            }

            zoneHistorique.on('mousedown touchstart', function () {
                startDrag(zoneHistorique, historiqueLayer, precedentParcours, (stage.getWidth() / 3), false, pointilleGauche);
            });

            zoneHistorique.on('mouseup mouseout touchend', function () {
                stopDrag(zoneHistorique);
            });

            zoneFutur.on('mousedown touchstart', function () {
                startDrag(zoneFutur, futurLayer, suiteParcours, (stage.getWidth() / 3) * 2, true, pointilleDroite);
            });

            zoneFutur.on('mouseup mouseout touchend', function () {
                stopDrag(zoneFutur);
            });


            /* Zone historique */
            
            for (var h = historique.length - 1; h >= 0 && historique.length != 0; h--) {
                var noeudHisto = getNodeById(historique[h]);

                var group = new Kinetic.Group({
                    name: historique[h]
                });

                var colorNoeud = COLOR1;
                if (noeudHisto.parcours.length == 0) {
                    colorNoeud = COLORDEFAULT;
                }

                var rond = new Kinetic.Circle({
                    x: stage.getWidth() / 3 - ((precedentParcours.length + 1) * 200),
                    y: stage.getHeight() / 3,
                    radius: 20,
                    fill: colorNoeud,
                    stroke: STROKECOLOR,
                    strokeWidth: 2
                });

                var texteAAfficher = formatNameByLength(noeudHisto.data.nom, 10)

                var texte = new Kinetic.Text({
                    x: stage.getWidth() / 3 - ((precedentParcours.length + 1) * 200) - (texteAAfficher.length / 2) * 10,
                    y: stage.getHeight() / 3 - 60,
                    text: texteAAfficher,
                    fill: TEXTCOLOR,
                    fontSize: 30,
                    fontFamily: 'Calibri'
                });

                group.on("click tap", function () {
                    historique.push(noeud.id);
                    var url = "exploration.html?parcours=" + parcours.id + "&noeud=" + this.getName() + "&historique=";
                    for (var h in historique) {
                        if (h != 0) {
                            url += "N";
                        }
                        url += historique[h];
                    }
                    window.location = url;
                });


                group.add(texte);
                group.add(rond);

                precedentParcours.push(group);

            }


            /* Zone selection */


            var colorNoeud = COLOR1;
            if (noeud.parcours.length == 0) {
                colorNoeud = COLORDEFAULT;
            }

            var rondNoeud = new Kinetic.Circle({
                x: stage.getWidth() / 2,
                y: stage.getHeight() / 3,
                radius: 20,
                fill: colorNoeud,
                stroke: STROKECOLOR,
                strokeWidth: 2
            });

            var rondNoeudSel = new Kinetic.Circle({
                x: stage.getWidth() / 2,
                y: stage.getHeight() / 3,
                radius: 15,
                fill: COLOR2
            });


            var texteNoeud = new Kinetic.Text({
                x: stage.getWidth() / 2 - (noeud.data.nom.length / 2) * 10,
                y: stage.getHeight() / 3 - 60,
                text: noeud.data.nom,
                fill: TEXTCOLOR,
                fontSize: 30,
                fontFamily: 'Calibri'
            });


            /* Zone futur */

            // Récupération noeuds voisins
            if (noeud.voisins.length != 0) {
                var nbVoisinsParcours = 0;
                var nbVoisinsSimple = 0;
                var voisinSimple;
                var voisinParcours;
                for (var v in noeud.voisins) {
                    var monVoisin = getNodeById(noeud.voisins[v].id);
                    if (monVoisin.parcours.length == 0) {
                        if (nbVoisinsSimple == 0) {
                            //Création du lien
                            voisinSimple = new Kinetic.Group({
                                name: noeud.voisins[v].id
                            });
                            voisinSimple.add(new Kinetic.Rect({
                                x: stage.getWidth() / 3 * 2 + ((suiteParcours.length) * 200),
                                y: stage.getHeight() / 3,
                                fill: COLORDEFAULT,
                                width: 200,
                                height: (stage.getHeight() / 6) * 5 - stage.getHeight() / 3,
                                opacity: 0
                            }));
                            voisinSimple.add(new Kinetic.Line({
                                name: "line",
                                points: [stage.getWidth() / 3 * 2 + ((suiteParcours.length) * 200), stage.getHeight() / 3, stage.getWidth() / 3 * 2 + ((suiteParcours.length + 1) * 200), (stage.getHeight() / 6) * 5],
                                stroke: COLORDEFAULT,
                                strokeWidth: 15,
                            }));
                            voisinSimple.add(new Kinetic.Circle({
                                x: stage.getWidth() / 3 * 2 + ((suiteParcours.length + 1) * 200),
                                y: (stage.getHeight() / 6) * 5,
                                radius: 20,
                                fill: COLORDEFAULT,
                                stroke: STROKECOLOR,
                                strokeWidth: 2
                            }));
                            var texteAAfficher = formatNameByLength(monVoisin.data.nom, 10)
                            voisinSimple.add(new Kinetic.Text({
                                x: stage.getWidth() / 3 * 2 + ((suiteParcours.length + 1) * 200) - (texteAAfficher.length / 2) * 10,
                                y: (stage.getHeight() / 6) * 5 - 50,
                                text: texteAAfficher,
                                fill: TEXTCOLOR,
                                fontSize: 30,
                                fontFamily: 'Calibri'
                            }));
                            voisinSimple.on("click tap", function () {
                                historique.push(noeud.id);
                                var url = "exploration.html?parcours=" + parcours.id + "&noeud=" + this.getName() + "&historique=";
                                for (var h in historique) {
                                    if (h != 0) {
                                        url += "N";
                                    }
                                    url += historique[h];
                                }
                                window.location = url;
                            });
                            suiteParcours.push(voisinSimple);
                            nbVoisinsSimple++;
                        } else {
                            //TODO: MENU MULTI NOEUD
                        }
                    } else {
                        if (nbVoisinsParcours == 0) {
                            //TODO: LIEN PARCOURS
                        } else {
                            //TODO: MENU MULTI NOEUD
                        }
                    }

                }

            }

            // Récupération noeuds parcours

            var noeudParcoursPrecedent = noeud;
            var incrHisto = historique.length-1;
            while (!isNodeParcours(noeudParcoursPrecedent, parcours.id) && incrHisto >= 0) {
                noeudParcoursPrecedent = getNodeById(historique[incrHisto--]);
            }
            if (!isNodeParcours(noeudParcoursPrecedent, parcours.id)) {
                noeudParcoursPrecedent = getNodeById(parcours.debut);
            }

            var suivant = getParcoursFromNode(noeudParcoursPrecedent, parcours.id).suivant;
            while (suivant != -1) {
                var noeudSuivant = getNodeById(suivant);
                var group = new Kinetic.Group({
                    name: suivant
                });


                var rond = new Kinetic.Circle({
                    x: stage.getWidth() / 3 * 2 + ((suiteParcours.length ) * 200),
                    y: stage.getHeight() / 3,
                    radius: 20,
                    fill: COLOR1,
                    stroke: STROKECOLOR,
                    strokeWidth: 2
                });

                var texteAAfficher = formatNameByLength(noeudSuivant.data.nom, 10)

                var texte = new Kinetic.Text({
                    x: stage.getWidth() / 3 * 2 + ((suiteParcours.length ) * 200) - (texteAAfficher.length / 2) * 10,
                    y: stage.getHeight() / 3 - 60,
                    text: texteAAfficher,
                    fill: TEXTCOLOR,
                    fontSize: 30,
                    fontFamily: 'Calibri'
                });

                group.on("click tap", function () {
                    historique.push(noeud.id);
                    var url = "exploration.html?parcours=" + parcours.id + "&noeud=" + this.getName() + "&historique=";
                    for (var h in historique) {
                        if (h != 0) {
                            url += "N";
                        }
                        url += historique[h];
                    }
                    window.location = url;
                });


                group.add(texte);
                group.add(rond);

                suiteParcours.push(group);
                suivant = getParcoursFromNode(noeudSuivant, parcours.id).suivant;
            }

            lineLayer.add(parcoursLine);

            historiqueLayer.add(zoneHistorique);
            for (var rond in precedentParcours) {
                historiqueLayer.add(precedentParcours[rond]);
            }

            selectionLayer.add(zoneSelection);
            selectionLayer.add(texteNoeud);
            selectionLayer.add(rondNoeud);
            selectionLayer.add(rondNoeudSel);
            selectionLayer.add(pointilleGauche);
            selectionLayer.add(pointilleDroite);

            futurLayer.add(zoneFutur);
            for (var rond in suiteParcours) {
                futurLayer.add(suiteParcours[rond]);
            }



            stage.add(lineLayer);
            stage.add(selectionLayer);
            stage.add(historiqueLayer);
            stage.add(futurLayer);

            stage.add(debugLayer);

        }

    </script>

</body>
</html>
